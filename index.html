<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Compile MindAR with Feature Points</title>
  <style>
    .dropzone { border: 2px dashed #ccc; padding: 20px; text-align: center; margin-bottom: 10px; cursor: pointer; }
    .startButton { margin-top: 10px; padding: 5px 15px; }
    .error { color: red; }
    .tabs { display: flex; list-style: none; padding: 0; margin: 10px 0; flex-wrap: wrap; }
    .tabs__item { margin-right: 5px; padding: 5px 10px; border: 1px solid #ccc; cursor: pointer; }
    .tabs__item--active { background-color: #ddd; font-weight: bold; }
    canvas { border: 1px solid #000; display: block; margin-top: 10px; max-width: 100%; }
  </style>
</head>
<body>
  <div id="compile">

    <!-- Upload Tab -->
    <div id="upload-tab">
      <h2>Select target images and start</h2>
      <div class="dropzone" id="dropzone">Drag & Drop your images here</div>
      <p class="error" id="upload-error"></p>
      <button class="startButton" id="start-button">Start</button>
      <p id="progress-text">Progress: 0%</p>
    </div>

    <!-- Visualize Tab -->
    <div id="visualize-tab" style="display:none;">
      <h2>Visualize compiled targets</h2>
      <!-- Image selection -->
      <ul class="tabs" id="image-tabs"></ul>
      <!-- Scale selection -->
      <ul class="tabs" id="scale-tabs"></ul>
      <!-- Canvas -->
      <canvas id="target-canvas"></canvas>
      <!-- Download button -->
      <button class="startButton" id="download-button">Download compiled</button>
    </div>

  </div>

  <script>
    const dropzone = document.getElementById('dropzone');
    const startButton = document.getElementById('start-button');
    const uploadError = document.getElementById('upload-error');
    const progressText = document.getElementById('progress-text');
    const uploadTab = document.getElementById('upload-tab');
    const visualizeTab = document.getElementById('visualize-tab');
    const imageTabs = document.getElementById('image-tabs');
    const scaleTabs = document.getElementById('scale-tabs');
    const canvas = document.getElementById('target-canvas');
    const downloadButton = document.getElementById('download-button');

    let files = [];
    let compiledData = [];
    let exportedBuffer = null;
    let targetIndex = 0;
    let scaleIndex = 0;

    // ----- Drag & Drop -----
    dropzone.addEventListener('dragover', (e) => { e.preventDefault(); dropzone.style.background = '#eee'; });
    dropzone.addEventListener('dragleave', (e) => { e.preventDefault(); dropzone.style.background = ''; });
    dropzone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropzone.style.background = '';
      files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('image/'));
      dropzone.textContent = files.map(f => f.name).join(', ') || 'Drag & Drop your images here';
      uploadError.textContent = '';
    });

    // ----- Load image -----
    function loadImage(file) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = reject;
        img.src = URL.createObjectURL(file);
      });
    }

    // ----- Generate scales -----
    function generateScales(img, count = 20) {
      const scales = [];
      let w = img.width;
      let h = img.height;

      for (let i = 0; i < count; i++) {
        const scaleCanvas = document.createElement('canvas');
        scaleCanvas.width = Math.max(1, Math.round(w));
        scaleCanvas.height = Math.max(1, Math.round(h));
        const ctx = scaleCanvas.getContext('2d');
        ctx.drawImage(img, 0, 0, scaleCanvas.width, scaleCanvas.height);
        scales.push(scaleCanvas);

        w *= 0.9; // réduire 10% à chaque fois
        h *= 0.9;
      }

      return scales;
    }

    // ----- Generate feature points -----
    function generatePoints(img, numPoints = 50) {
      const points = [];
      for (let i = 0; i < numPoints; i++) {
        points.push({
          x: Math.random() * img.width,
          y: Math.random() * img.height,
          scale: 3 + Math.random() * 2 // taille aléatoire pour visibilité
        });
      }
      return points;
    }

    // ----- Compile files with scales and points -----
    async function compileFiles(files) {
      progressText.textContent = 'Progress: 0%';
      compiledData = [];

      for (let i = 0; i < files.length; i++) {
        const img = await loadImage(files[i]);
        const scales = generateScales(img, 20);
        const points = generatePoints(img, 50);
        compiledData.push({ original: img, scales, points });
        progressText.textContent = `Progress: ${Math.round(((i + 1)/files.length)*100)}%`;
      }

      exportedBuffer = new Uint8Array([1,2,3,4]); // simulation export

      // Switch tabs
      uploadTab.style.display = 'none';
      visualizeTab.style.display = 'block';
      setupTabs();
      drawCanvas();
    }

    startButton.addEventListener('click', async () => {
      if (files.length === 0) {
        uploadError.textContent = 'Please select images.';
        return;
      }
      await compileFiles(files);
    });

    // ----- Setup Tabs -----
    function setupTabs() {
      imageTabs.innerHTML = '';
      scaleTabs.innerHTML = '';

      compiledData.forEach((data, i) => {
        const li = document.createElement('li');
        li.textContent = `Image ${i+1}`;
        li.className = i===targetIndex ? 'tabs__item tabs__item--active' : 'tabs__item';
        li.onclick = () => { targetIndex=i; scaleIndex=0; updateTabs(); drawCanvas(); };
        imageTabs.appendChild(li);
      });

      updateTabs();
    }

    function updateTabs() {
      Array.from(imageTabs.children).forEach((li,i)=> li.className = i===targetIndex ? 'tabs__item tabs__item--active':'tabs__item');
      scaleTabs.innerHTML = '';
      compiledData[targetIndex].scales.forEach((scale,i)=>{
        const li = document.createElement('li');
        li.textContent = `Scale ${i+1}`;
        li.className = i===scaleIndex ? 'tabs__item tabs__item--active':'tabs__item';
        li.onclick = () => { scaleIndex=i; updateTabs(); drawCanvas(); };
        scaleTabs.appendChild(li);
      });
    }

    // ----- Draw Canvas with points -----
    function drawCanvas() {
      const scaleCanvas = compiledData[targetIndex].scales[scaleIndex];
      canvas.width = scaleCanvas.width;
      canvas.height = scaleCanvas.height;
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.drawImage(scaleCanvas,0,0);

      // Draw points
      compiledData[targetIndex].points.forEach(p=>{
        ctx.beginPath();
        ctx.arc(p.x*(scaleCanvas.width/compiledData[targetIndex].original.width), 
                p.y*(scaleCanvas.height/compiledData[targetIndex].original.height), 
                p.scale,0,2*Math.PI);
        ctx.fillStyle='red';
        ctx.fill();
        ctx.strokeStyle='black';
        ctx.stroke();
      });
    }

    // ----- Download buffer -----
    downloadButton.addEventListener('click',()=>{
      if(!exportedBuffer) return;
      const blob = new Blob([exportedBuffer], { type:'application/octet-stream' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download='targets.mind';
      a.click();
      URL.revokeObjectURL(a.href);
    });
  </script>
</body>
</html>
