<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Compile MindAR</title>
  <style>
    .dropzone { border: 2px dashed #ccc; padding: 20px; text-align: center; margin-bottom: 10px; cursor: pointer; }
    .startButton { margin-top: 10px; padding: 5px 15px; }
    .error { color: red; }
    .tabs { display: flex; list-style: none; padding: 0; margin: 10px 0; }
    .tabs__item { margin-right: 5px; padding: 5px 10px; border: 1px solid #ccc; cursor: pointer; }
    .tabs__item--active { background-color: #ddd; font-weight: bold; }
    canvas { border: 1px solid #000; display: block; margin-top: 10px; max-width: 100%; }
  </style>
</head>
<body>
  <div id="compile">

    <!-- Upload Tab -->
    <div id="upload-tab">
      <h2>Select target images and start</h2>
      <div class="dropzone" id="dropzone">Drag & Drop your images here</div>
      <p class="error" id="upload-error"></p>
      <button class="startButton" id="start-button">Start</button>
      <p id="progress-text">Progress: 0%</p>
    </div>

    <!-- Visualize Tab -->
    <div id="visualize-tab" style="display:none;">
      <h2>Visualize compiled targets</h2>

      <!-- Image selection -->
      <ul class="tabs" id="image-tabs"></ul>

      <!-- Scale selection -->
      <ul class="tabs" id="scale-tabs"></ul>

      <!-- Canvas -->
      <canvas id="target-canvas" width="640" height="480"></canvas>

      <!-- Download button -->
      <button class="startButton" id="download-button">Download compiled</button>
    </div>

  </div>

  <script>
    // ----- Variables globales -----
    const dropzone = document.getElementById('dropzone');
    const startButton = document.getElementById('start-button');
    const uploadError = document.getElementById('upload-error');
    const progressText = document.getElementById('progress-text');
    const uploadTab = document.getElementById('upload-tab');
    const visualizeTab = document.getElementById('visualize-tab');
    const imageTabs = document.getElementById('image-tabs');
    const scaleTabs = document.getElementById('scale-tabs');
    const canvas = document.getElementById('target-canvas');
    const downloadButton = document.getElementById('download-button');

    let files = [];
    let compiledData = [];
    let exportedBuffer = null;
    let targetIndex = 0;
    let scaleIndex = 0;

    // ----- Drag & Drop -----
    dropzone.addEventListener('dragover', (e) => { e.preventDefault(); dropzone.style.background = '#eee'; });
    dropzone.addEventListener('dragleave', (e) => { e.preventDefault(); dropzone.style.background = ''; });
    dropzone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropzone.style.background = '';
      files = Array.from(e.dataTransfer.files).filter(f => f.type.startsWith('image/'));
      dropzone.textContent = files.map(f => f.name).join(', ') || 'Drag & Drop your images here';
      uploadError.textContent = '';
    });

    // ----- Load image as HTMLImageElement -----
    function loadImage(file) {
      return new Promise((resolve, reject) => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = reject;
        img.src = URL.createObjectURL(file);
      });
    }

    // ----- Simulate compile -----
    async function compileFiles(files) {
      progressText.textContent = 'Progress: 0%';
      compiledData = [];

      for (let i = 0; i < files.length; i++) {
        const img = await loadImage(files[i]);
        compiledData.push({
          image: img,
          width: img.width,
          height: img.height,
          scales: [img], // simulate scales
          points: [
            { x: img.width / 2, y: img.height / 2, scale: 5 }
          ]
        });
        progressText.textContent = `Progress: ${Math.round(((i + 1) / files.length) * 100)}%`;
      }

      // Simulate exported buffer
      exportedBuffer = new Uint8Array([1,2,3,4]);

      // Switch to visualize tab
      uploadTab.style.display = 'none';
      visualizeTab.style.display = 'block';

      setupTabs();
      drawCanvas();
    }

    // ----- Start button -----
    startButton.addEventListener('click', async () => {
      if (files.length === 0) {
        uploadError.textContent = 'Please select images.';
        return;
      }
      await compileFiles(files);
    });

    // ----- Setup Image & Scale Tabs -----
    function setupTabs() {
      imageTabs.innerHTML = '';
      scaleTabs.innerHTML = '';

      compiledData.forEach((data, i) => {
        const li = document.createElement('li');
        li.textContent = `Image ${i+1}`;
        li.className = i === targetIndex ? 'tabs__item tabs__item--active' : 'tabs__item';
        li.onclick = () => { targetIndex = i; scaleIndex = 0; updateTabs(); drawCanvas(); };
        imageTabs.appendChild(li);

        // For scales
        data.scales.forEach((_, j) => {
          if (i === targetIndex) {
            const sli = document.createElement('li');
            sli.textContent = `Scale ${j+1}`;
            sli.className = j === scaleIndex ? 'tabs__item tabs__item--active' : 'tabs__item';
            sli.onclick = () => { scaleIndex = j; updateTabs(); drawCanvas(); };
            scaleTabs.appendChild(sli);
          }
        });
      });
    }

    function updateTabs() {
      Array.from(imageTabs.children).forEach((li, i) => li.className = i === targetIndex ? 'tabs__item tabs__item--active' : 'tabs__item');
      scaleTabs.innerHTML = '';
      compiledData[targetIndex].scales.forEach((_, j) => {
        const li = document.createElement('li');
        li.textContent = `Scale ${j+1}`;
        li.className = j === scaleIndex ? 'tabs__item tabs__item--active' : 'tabs__item';
        li.onclick = () => { scaleIndex = j; updateTabs(); drawCanvas(); };
        scaleTabs.appendChild(li);
      });
    }

    // ----- Draw Canvas -----
    function drawCanvas() {
      const data = compiledData[targetIndex];
      const img = data.scales[scaleIndex];
      canvas.width = img.width;
      canvas.height = img.height;
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.drawImage(img, 0, 0);

      // draw points
      data.points.forEach(p => {
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.scale, 0, 2*Math.PI);
        ctx.strokeStyle = 'red';
        ctx.stroke();
      });
    }

    // ----- Download simulated buffer -----
    downloadButton.addEventListener('click', () => {
      if (!exportedBuffer) return;
      const blob = new Blob([exportedBuffer], { type: 'application/octet-stream' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'targets.mind';
      a.click();
      URL.revokeObjectURL(a.href);
    });
  </script>
</body>
</html>
